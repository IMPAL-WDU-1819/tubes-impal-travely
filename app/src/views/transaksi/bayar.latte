<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link rel="stylesheet" href="../../public/css/bootstrap.min.css">
	<link rel="stylesheet" href="../../public/css/extra.css">
	<link rel="icon" href="../../public/favicon.ico">
	<title>Pesan Tiket Kereta Murah dan Mudah Hanya di Travely</title>
</head>
<body>
	<section id="nav">
		<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
			<div class="container">
				<a class="navbar-brand" href="/">Travely</a>
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<ul class="navbar-nav mr-auto">
					</ul>
					<ul class="navbar-nav">
						<li class="nav-item">
							<a class="nav-link" href="#">Promo</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">Booking</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">Layanan</a>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								Akun
							</a>
							<div class="dropdown-menu" aria-labelledby="navbarDropdown">
								{if $akun}
								<a n:if="$akun" class="dropdown-item" href="/akun">Akun</a>
								<a n:if="$akun" class="dropdown-item" href="/keluar">Keluar</a>
								{else}
								<a class="dropdown-item" href="/masuk">Masuk</a>
								<a class="dropdown-item" href="/daftar">Daftar</a>
								{/if}
							</div>
						</li>
					</ul>
				</div>
			</div>
		</nav>
	</section>
	<section id="content">
		<div class="container">
			<div class="row">
				<div class="col-6">
					<ul class="nav nav-tabs mb-6" id="pills-tab" role="tablist">
						<li class="nav-item">
							<a class="nav-link active" id="pills-atm-tab" data-toggle="pill" href="#pills-atm" role="tab" aria-controls="pills-atm" aria-selected="true">Transfer/ATM</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="pills-kredit-tab" data-toggle="pill" href="#pills-kredit" role="tab" aria-controls="pills-kredit" aria-selected="true">Kartu Kredit</a>
						</li>
					</ul>
					<div class="tab-content" id="pills-tabContent">
						<div class="tab-pane fade show active" id="pills-atm" role="tabpanel" aria-labelledby="pills-atm-tab">
							<form id="tform" enctype="multipart/form-data">
								<div class="container">
									<div class="row">
										<div class="col-12">
											<br>
											<h6>Pilih Bank: </h6>
											<select class="custom-select" name="bank" id="bank" required="required">
												<option selected disabled="disabled">Pilih Salah Satu Bank</option>
												<option value="bca">BCA</option>
												<option value="bni">BNI</option>
												<option value="mandiri">Mandiri</option>
												<option value="bri">BRI</option>
											</select>
											<br>
											<br>
											<div class="card">
												<div class="card-header">
													<h6 class="card-title font-weight-bold">Detail Pembayaran</h6>
												</div>
												<div class="card-body">
													<div class="row">
														<div class="col-6">
															<p>Jumlah Tiket</p>
															<p class="font-weight-bold">{$jumlah} Dewasa</p>
														</div>
														<div class="col-6">
															<p>Total Harga</p>
															<p n:foreach="$jadwal as $j" class="font-weight-bold text-success">Rp. <span id="harga1">{$j->harga}</span></p>
														</div>
													</div>
													<div class="row mt-4">
														<div class="col-12">
															<h6 class="font-weight-bold">Detail Transfer</h6>
															<p>Silahkan transfer dengan kode unik : 000</p>
															<ul>
																<li>BCA : 123871249</li>
																<li>BNI : 918273479</li>
																<li>Mandiri : 462731912</li>
																<li>BRI : 25371242</li>
															</ul>
														</div>
													</div>
													<div class="row mt-4">
														<div class="col-12">
															<h6 class="font-weight-bold">Upload Bukti Pembayaran</h6>
															<input type="file" name="bukti" id="bukti" required="required">
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<p class="mt-3"><small>Dengan menekan tombol dibawah berarti anda sudah membaca dan menyetujui <span><a href="#">kebijakan dan ketentuan berlaku</a></span></small></p>
											<button type="submit" class="btn btn-primary btn-block mt-3">Bayar Tiket</button>
										</div>
									</div>
								</div>
							</form>
						</div>        
						<div class="tab-pane fade" id="pills-kredit" role="tabpanel" aria-labelledby="pills-kredit-tab">
							<form id="ccform">
								<div class="container">
									<div class="row">
										<div class="col-8">
											<p class="mt-4">Nomor Kartu: </p>
											<input type="text" name="nokartu" class="form-control" placeholder="4444 4444 4444 4444" required="required">
										</div>
										<div class="col-4">
											<p class="mt-4">Kode CVC: </p>
											<input type="text" name="cvc" class="form-control" placeholder="123" required="required">
										</div>
									</div>
									<div class="row mt-3">
										<div class="col-4">
											<p>Valid Sampai: </p>
											<input type="text" name="novalid" class="form-control" placeholder="12/12" required="required">
										</div>
										<div class="col-8">
											<p>Nama Pengguna: </p>
											<input type="text" name="namacc" class="form-control" placeholder="John Doe" required="required">
										</div>
									</div>
									<div class="row mt-4">
										<div class="col-12">
											<div class="card">
												<div class="card-header">
													<h6 class="font-weight-bold">Detail Pembayaran</h6>
												</div>
												<div class="card-body">
													<div class="row">
														<div class="col-6">
															<p>Jumlah Tiket</p>
															<p class="font-weight-bold">{$jumlah} Dewasa</p>
														</div>
														<div class="col-6">
															<p>Total Harga</p>
															<p n:foreach="$jadwal as $j" class="font-weight-bold text-success" id="harga2">Rp. <span id="harga2">{$j->harga}</span></p>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<p class="mt-4"><small>Dengan menekan tombol dibawah berarti anda sudah membaca dan menyetujui <span><a href="#">kebijakan dan ketentuan berlaku</a></span></small></p>
											<input type="submit" class="btn btn-primary btn-block mt-3" value="Bayar Tiket">
										</div>
									</div>	
								</div>
							</form>
						</div>
					</div>
				</div>
				<div class="col-6">
					<!-- <img class="img-fluid" src="../public/img/home.jpg" alt=""> -->
				</div>
			</div>
		</div>
	</section>	
	<script src="../../public/js/jquery-3.3.1.js"></script>
	<script src="../../public/js/popper.min.js"></script>
	<script src="../../public/js/bootstrap.min.js"></script>
	<script>
		$(() => {
			if (localStorage.penumpang) penumpang = JSON.parse(localStorage.penumpang)
		})
		
		let rand = new Date()
		const tid = rand.getTime()

		let ssid = parseInt({$id})
		let ssjumlah = parseInt({$jumlah})

		let details = () => {
			for (let i in penumpang) {
				let id = rand.getTime() + Math.floor(Math.random() * 10)
				$.ajax({
					url: '/transaksi/tiket',
					type: 'POST',
					data: {
						id: id,
						transaksi: tid,
						kursi: penumpang[i].Kursi,
						identitas: penumpang[i].Identitas,
						nama: penumpang[i].Nama,
						jadwal: {$id}
					},
					dataType: 'json'
				})
			}
		}

		let upload = () => {
			let _submit = document.getElementById('bukti');
			let formData = new FormData();
			formData.append('bukti', _submit.files[0]);
			formData.append('id', tid)
			$.ajax({
			url: '/transaksi/upload',
				type: 'POST',
				data: formData,
				dataType: 'json',
				cache: false,
				contentType: false,
				processData: false
			})
		}

		let transfer = () => {
			$.ajax({
				url: '/transaksi/bayar',
				type: 'POST',
				data: {
					transaksi: tid,
					akun: {$akun},
					total: parseInt($('#harga1').text()) * ssjumlah,
					tipe: 'Transfer',
					bank: $('#bank option:selected').text()
				},
				dataType: 'json'
			})
		}

		let cc = () => {
			$.ajax({
				url: '/transaksi/bayar',
				type: 'POST',
				data: {
					transaksi: tid,
					akun: {$akun},
					total: parseInt($('#harga2').text()) * ssjumlah,
					tipe: 'CC',
					bank: '-'
				},
				dataType: 'json'
			})
		}

		$('#tform').on('submit', ((e) => {
			e.preventDefault()
			if ({$akun} == '') {
				alert('Anda harus login terlebih dahulu')
				window.location = '/transaksi/bayar/' + ssid + '?jumlah=' + ssjumlah
			} else {
				$.when(transfer(), details(), upload()).then(() => {
					setTimeout(() => {
						window.location = '/transaksi/tiket'
					}, 500)
				})
			}
		}))

		$('#ccform').on('submit', ((e) => {
			e.preventDefault()
			if ({$akun} == '') {
				alert('Anda harus login terlebih dahulu')
				window.location = '/transaksi/bayar/' + ssid + '?jumlah=' + ssjumlah
			} else {
				$.when(cc(), details()).then(() => {
					setTimeout(() => {
						window.location = '/transaksi/tiket'
					}, 500)
				})
			}
		}))
	</script>
</body>
</html>
